# -*- coding: utf-8 -*-
"""
<parameters>
    <company>d.gavrilov</company>
    <title>folder_cleaner</title>
    <version>1.0.4</version>
    <parameter>
        <id>FOLDER</id>
        <type>string</type>
        <name>Path to folder</name>
        <value>default</value>
    </parameter>
    <parameter>
        <type>integer</type>
        <name>Free space(mb)</name>
        <id>MIN_FREE_SPACE</id>
        <value>500</value>
        <min>0</min>
        <max>100000</max>
    </parameter>
    <parameter>
        <type>integer</type>
        <name>Check interval(min)</name>
        <id>CHECK_INTERVAL</id>
        <value>10</value>
        <min>1</min>
        <max>10000</max>
    </parameter>
    <parameter>
        <type>integer</type>
        <name>File age(days)</name>
        <id>FILE_AGE</id>
        <value>10</value>
        <min>1</min>
        <max>100000</max>
    </parameter>
    <parameter>
        <id>FILTER_EXT</id>
        <type>string</type>
        <name>Filter ext</name>
        <value></value>
    </parameter>
    <parameter>
        <id>DEBUG</id>
        <name>Debug mode</name>
        <type>boolean</type>
        <value>False</value>
        </parameter>
    <resources>
        <resource>helpers.py</resource>
    </resources>
</parameters>
"""

resources = {
    "helpers.py": """
        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
        WIuvlCgz6f8DOZtdDw==
    """,
}
t1utils.resources_check(script_path, resources)

GLOBALS = globals()
MIN_FREE_SPACE = GLOBALS.get("MIN_FREE_SPACE", 500)
FOLDER = GLOBALS.get("FOLDER", "")
CHECK_INTERVAL = GLOBALS.get("CHECK_INTERVAL", 1)
FILE_AGE = GLOBALS.get("FILE_AGE", 10)
FILTER_EXT = GLOBALS.get("FILTER_EXT", "")
DEBUG = GLOBALS.get("DEBUG", False)

import helpers

helpers.set_script_name()
logger = helpers.init_logger("folder_cleaner", debug=DEBUG)

logger.debug(
    "script started with params folder:%s, free space(Mb):%s, check interval(min):%s, file age(days):%s, "
    "filter ext: %s",
    FOLDER,
    MIN_FREE_SPACE,
    CHECK_INTERVAL,
    FILE_AGE,
    FILTER_EXT,
)

import psutil
import time
import os
import host


def _win_encode_path(path):
    if os.name == "nt":
        try:
            path = path.decode("utf8")
        except (UnicodeDecodeError, UnicodeEncodeError):
            pass
    return path


if FOLDER in ("default", ""):
    FOLDER = host.settings("system_wide_options")["screenshots_folder"]

clean_folder = _win_encode_path(FOLDER)
ext_list = None
if FILTER_EXT:
    ext_list = ["." + ext.strip() for ext in FILTER_EXT.split(",")]

if not os.path.exists(clean_folder):
    raise OSError("folder not found")


def folder_checker(folder_path, file_age, extension_list, disk_space, min_free_space):
    _file_count = 0
    _free_space = disk_space // 1024 // 1024
    for dir_path, dir_name, file_names in os.walk(folder_path):
        for file_name in file_names:
            _file_count += 1
            fp = os.path.join(dir_path, file_name)
            diff_time = time.time() - os.path.getctime(fp)
            file_name, extension = os.path.splitext(fp)
            if min_free_space == 0:
                if extension_list:
                    if extension in extension_list:
                        delete_file(diff_time, file_age, file_name, fp)
                    else:
                        continue
                else:
                    raise ValueError("Need to specify file extension")
            else:
                if extension_list:
                    if extension in extension_list:
                        delete_file(diff_time, file_age, file_name, fp)
                    else:
                        continue

                else:
                    delete_file(diff_time, file_age, file_name, fp)
        if _file_count == 0:
            logger.warning(
                "Nothing to delete, free disk space %s mb" % str(_free_space)
            )


def delete_file(diff_time, file_age, file_name, fp):
    if diff_time > file_age * 24 * 3600:
        try:
            logger.debug("remove file: %s", file_name)
            os.remove(fp)
        except OSError as e:
            logger.warning(str(e))


def loop():
    free_disk_space = int(psutil.disk_usage(clean_folder).free)
    if MIN_FREE_SPACE == 0:
        folder_checker(
            clean_folder, FILE_AGE, ext_list, free_disk_space, MIN_FREE_SPACE
        )
        host.timeout(CHECK_INTERVAL * 60000, loop)
    else:
        if free_disk_space < MIN_FREE_SPACE * 1024 * 1024:
            folder_checker(
                clean_folder, FILE_AGE, ext_list, free_disk_space, MIN_FREE_SPACE
            )
            host.timeout(CHECK_INTERVAL * 60000, loop)


loop()
