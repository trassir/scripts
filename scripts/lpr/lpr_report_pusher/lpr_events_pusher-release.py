# -*- coding: utf-8 -*-
# lpr_events_pusher v1.0.0
"""
<parameters>
    <company>DSSL</company>
    <author>d.gavrilov</author>
    <title>lpr_events_pusher</title>
    <version>1.0.0</version>
    <parameter>
        <id>URL</id>
        <name>URL</name>
        <type>string</type>
        <value></value>
    </parameter>
    <parameter>
        <type>boolean</type>
        <id>DEBUG</id>
        <name>Debug</name>
        <value>False</value>
   </parameter>
    <resources>
        <resource>helpers.py</resource>
    </resources>
</parameters>
"""

resources = {
    "helpers.py": """
        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
    """,
}
t1utils.resources_check(script_path, resources)
GLOBALS = globals()
URL = GLOBALS.get("URL", "")
DEBUG = GLOBALS.get("DEBUG", False)

import helpers

helpers.set_script_name()
logger = helpers.init_logger("lpr_events_pusher", debug=DEBUG)

import host
import json
import requests
import threading
from functools import wraps
from __builtin__ import object

assert URL, "No address specified for POST request"


def _run_as_thread(fn):
    @wraps(fn)
    def run(*args, **kwargs):
        t = threading.Thread(target=fn, args=args, kwargs=kwargs)
        t.daemon = True
        t.start()
        return t

    return run


session = requests.Session()
session.verify = False
session.headers.update(
    {"Content-type": "application/json; charset=utf-8", }
)


class LprEventsPusher(object):
    def __init__(self, url):
        self.url = url

    def __call__(self, ev):
        data = self.prepare_data(ev)
        self.send_request(data)

    def prepare_data(self, event):
        data = {
            "id": event.id,
            "plate": event.plate,
            "best_guess": getattr(event, "best_guess", ""),
            "radar_speed": getattr(event, "radar_speed", 0.0),
            "country": getattr(event, "country", ""),
            "lane": getattr(event, "lane", 0),
            "server": {
                "name": self.get_object_name(event.server),
                "guid": event.server,
            },
            "channel": {
                "name": self.get_object_name(event.channel),
                "guid": event.channel,
            },
            "direction": self.get_direction(event.flags),
            "vehicle_type": getattr(event, "vehicle_type", ""),
            "quality": event.quality,
            "time_enter": event.time_enter,
            "time_bestview": event.time_bestview,
            "time_leave": event.time_leave,
            "matched_embrecords_history": self.get_matched_embrecords_history(event),
            "matched_extlists_history": self.get_matched_extlists_history(event),
        }
        return data

    @staticmethod
    def get_matched_embrecords_history(ev):
        matched_embrecords = []
        if ev.matched_embrecords_history:
            for emblist_record, emblist in ev.matched_embrecords_history:
                matched_embrecords.append(
                    {"reaction": emblist.reaction, "comment": emblist_record.comment}
                )
        return matched_embrecords

    @staticmethod
    def get_matched_extlists_history(ev):
        matched_extlists = []
        if getattr(ev, "matched_extlists_history"):
            for element in ev.matched_extlists_history:
                matched_extlists.append(
                    {
                        "reaction": element.get("reaction"),
                        "comment": element.get("comment"),
                    }
                )
        return matched_extlists

    @staticmethod
    def get_object_name(guid):
        try:
            return host.object(guid).name
        except EnvironmentError:
            return guid

    @staticmethod
    def get_direction(lpr_flags):
        if lpr_flags & host.LPR_UP:
            return "UP"
        else:
            return "DOWN"

    @_run_as_thread
    def send_request(self, data):
        try:
            response = session.post(self.url, data=json.dumps(data, ensure_ascii=False))
            logger.debug(data)
            logger.debug("[%s] %s", response.status_code, response.text)
        except Exception as err:
            logger.warning(str(err))


lep = LprEventsPusher(URL)
host.activate_on_lpr_events(lep)
