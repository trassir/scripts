# -*- coding: utf-8 -*-
# IP Device info v1.0.1
"""
<parameters>
    <company>MNRudkovskyi</company>
    <title>IP Device info</title>
    <version>1.0.1</version>

    <parameter>
        <id>DEBUG</id>
        <type>boolean</type>
        <name>Debug</name>
        <value>False</value>
    </parameter>

    <resources>
        <resource>export.py</resource>
        <resource>helpers.py</resource>
    </resources>
</parameters>
"""

resources = {
    "export.py": """
        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
        Mw==
    """,
    "helpers.py": """
        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
        WIuvlCgz6f8DOZtdDw==
    """,
}
t1utils.resources_check(script_path, resources)

import host
import helpers

GLOBALS = globals()
DEBUG = GLOBALS.get("DEBUG", False)

logger = helpers.init_logger("IP_Device_info", debug=DEBUG)

from export import save_data

screen_folder = host.settings("system_wide_options")["screenshots_folder"]


grabber_feedback_state = {
    1: "On Work",
    0: "No Work",
    3: "Exceed specification",
    4: "Invalid argument specified",
    9: "Wrong login or password",
    8: "Wrong login or password",
    1025: "On Work - No HDD",
    2051: "Exceed specification - HDD ok",
    1027: "Exceed specification - No HDD",
    2049: "On Work - HDD ok",
    8193: "On Work - HDD not format",
    1537: "On Work - No HDD",
}

type_motion_detector = {
    0: "Off or AutoTrassir",
    3: "Hardware",
    1: "Active",
    11: "Active HD",
    2: "Simt",
}


def get_data_from_ip_device(server_guid):
    device_info = {}
    for sett in host.settings("/{}/ip_cameras".format(server_guid)).ls():
        if sett.type == "Grabber":
            if sett["grabber_enabled"]:
                device_info["name"] = sett["name"]
                device_info["connection_ip"] = sett["connection_ip"]
                device_info["connection_port"] = sett["connection_port"]
                device_info["channel"] = get_data_from_channel(sett, server_guid)
                device_info["model"] = sett["model"]
                feedback = sett.cd("feedback")
                if feedback:
                    device_info["state"] = grabber_feedback_state.get(feedback["state"], "Unknown")
                logger.debug("device info: %s", device_info)

                yield device_info


def get_data_from_channel(sett, server_guid):
    channel_info = {}
    for ch_number in xrange(31):
        if sett["channel%02d_guid" % ch_number]:
            try:
                ch_object = host.object(sett["channel%02d_guid" % ch_number])
                channel_info["ch_name"] = ch_object.name
                channel_info["motion_detector"] = type_motion_detector.get(
                    host.settings(
                        "/{}/channels/{}".format(server_guid, ch_object.guid)
                    )["software_md_enable"],
                    "Unknown",
                )
            except EnvironmentError:
                logger.debug(
                    "Channel guid '%s' has no name, most likely the streams are disabled for the registrar channel",
                    sett["channel%02d_guid" % ch_number],
                )
                continue
            channel_info["codec"] = sett["channel%02d_codec" % ch_number]
            channel_info["audio_enabled"] = (
                "On" if sett["channel%02d_audio_enabled" % ch_number] else "Off"
            )
            channel_info["audio_codec"] = sett["channel%02d_audio_codec" % ch_number]
            channel_info["main"] = (
                "On" if sett["channel%02d_main_enabled" % ch_number] else "Off"
            )
            channel_info["main_fps"] = sett["channel%02d_fps" % ch_number]
            channel_info["main_gop"] = sett["channel%02d_gop" % ch_number]
            channel_info["main_resolution"] = sett["channel%02d_resolution" % ch_number]
            channel_info["sub"] = (
                "On" if sett["channel%02d_ext_gop" % ch_number] else "Off"
            )
            channel_info["sub_fps"] = sett["channel%02d_ext_fps" % ch_number]
            channel_info["sub_gop"] = sett["channel%02d_ext_gop" % ch_number]
            channel_info["sub_resolution"] = sett[
                "channel%02d_ext_resolution" % ch_number
            ]
            logger.debug("channel info: %s", channel_info)

            yield channel_info
        else:
            break


def get_data_from_server():
    data_from_server = {}
    for srv in host.settings("/").ls():
        if srv.type == "RemoteServer" or srv.type == "LocalServer":
            logger.debug("Server: name %s, guid %s", srv.name, srv.guid)
            data_from_server["server_name"] = srv.name
            data_from_server["ip_device_info"] = get_data_from_ip_device(srv.guid)
            host.stats()["run_count"] += 1

            yield data_from_server


if __name__ == host.stats().parent().guid:
    default_script_name = helpers.set_script_name()

    data = get_data_from_server()

    save_data(data, screen_folder)
