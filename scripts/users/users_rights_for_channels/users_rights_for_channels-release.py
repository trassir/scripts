# -*- coding: utf-8 -*-
# users_rights_for_channels v1.0.1
"""
<parameters>
    <company>DSSL</company>
    <author>d.gavrilov</author>
    <title>users_rights_for_channels</title>
    <version>1.0.1</version>
    <parameter>
        <type>caption</type>
        <name>Main settings</name>
    </parameter>
    <parameter>
        <type>string</type>
        <name>Folder path</name>
        <id>FOLDER_PATH</id>
        <value>default</value>
    </parameter>

    <parameter>
        <type>caption</type>
        <name>Other settings</name>
    </parameter>
    <parameter>
        <type>boolean</type>
        <id>DEBUG</id>
        <name>Debug mode</name>
        <value>False</value>
   </parameter>
    <resources>
        <resource>helpers.py</resource>
        <resource>localization/report.py</resource>
        <resource>localization/__init__.py</resource>
    </resources>
</parameters>
"""

resources = {
    "helpers.py": """
        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
    """,
    "localization/report.py": """
        eNpLzkksLlYISi3ILyrRyE/KSk0u0bTi5VIAgtLi1KK8xNxUBVsFpVAoWwkiBeSVpRbFw2SD
        wVwFJAXJGYl5eak5cBXOED6ykrLM1HKQVBiQhgolFiVnZJaBNThCmDD78kvzUsA2gRhQwYKS
        KpBQQEgUVCA3PyUzrRIk5gtmwR1bUloAcSaQARQEAM/eRWA=
    """,
    "localization/__init__.py": """
        eNpLK8rPVdArSi3ILypRyMwFU0FgHi8XLxdU3BYqpKHJywUAsVoQIQ==
    """,
}
t1utils.resources_check(script_path, resources)
GLOBALS = globals()
# Main settings
FOLDER_PATH = GLOBALS.get("FOLDER_PATH", "default") or None

# Other settings
DEBUG = GLOBALS.get("DEBUG", False)

import helpers

helpers.set_script_name()
logger = helpers.init_logger("user_rights_for_channels", debug=DEBUG)

import host
import os
import re
from datetime import datetime
import xlsxwriter
from __builtin__ import object
import localization as loc

shot_path = host.settings("system_wide_options")["screenshots_folder"]
host.stats()["run_count"] = 0


def _win_encode_path(path):
    if os.name == "nt":
        try:
            path = path.decode("utf8")
        except (UnicodeDecodeError, UnicodeEncodeError):
            pass
    return path


if FOLDER_PATH in ["default", None]:
    FOLDER_PATH = shot_path
else:
    if not os.path.isdir(_win_encode_path(FOLDER_PATH)):
        raise ValueError("Folder not found -> %s" % FOLDER_PATH)
    else:
        FOLDER_PATH = _win_encode_path(FOLDER_PATH)


class UserRightsChecker(object):
    max_bit = 32
    alc_regexp = re.compile(r"([\w/]+),(\d+)")

    def __init__(self, user_settings):
        assert user_settings
        assert user_settings.type == "User"
        self.__user_settings = user_settings
        self._base_rights = self.parse(user_settings["base_rights"], self.max_bit)
        self._acl_rights = self.collect_acl_rights(user_settings["acl"])
        self._group_acl_rights = None
        if user_settings.group_acl:
            self._group_acl_rights = self.collect_acl_rights(user_settings.group_acl)

    def collect_acl_rights(self, settings):
        acl_rights = {}
        if settings:
            for match in self.alc_regexp.finditer(settings):
                acl_rights[match.group(1)] = self.parse(match.group(2), 64)
        return acl_rights

    @classmethod
    def parse(cls, value, max_bits=32):
        return [
            bool(int(bit)) for bit in reversed(format(int(value), "0%sb" % max_bits))
        ]

    def _check(self, access, acl, check_path, key, key_):
        if access:
            access = not acl[check_path][key_]
        else:
            access = acl[check_path][key]
        return access

    def check_rights(self, setting_path, key):
        access = self._base_rights[key]
        key_ = key + 32
        split_setting_path = setting_path.split("/")[1:]
        check_path = ""
        for path in split_setting_path:
            check_path += "/%s" % path
            if self._group_acl_rights and check_path in self._group_acl_rights:
                access = self._check(
                    access, self._group_acl_rights, check_path, key, key_
                )

            if check_path in self._acl_rights:
                access = self._check(access, self._acl_rights, check_path, key, key_)
        return access

    def check_view_rights(self, setting_path):
        return self.check_rights(setting_path, 0)

    def check_archive_rights(self, setting_path):
        return self.check_rights(setting_path, 1)

    def check_modify_rights(self, setting_path):
        return self.check_rights(setting_path, 2)

    def check_setup_rights(self, setting_path):
        return self.check_rights(setting_path, 3)

    def check_bookmark_rights(self, setting_path):
        return self.check_rights(setting_path, 5)

    def check_users_and_script_rights(self, setting_path):
        return self.check_rights(setting_path, 6)

    def check_archive_export(self, setting_path):
        return self.check_rights(setting_path, 8)

    def check_ptz_rights(self, setting_path):
        return self.check_rights(setting_path, 9)

    def check_sound_rights(self, setting_path):
        return self.check_rights(setting_path, 10)

    @property
    def check_archive_speed_limit(self):
        return self.__user_settings["archive_speed_limit"]

    @property
    def check_ptz_priority(self):
        return self.__user_settings["ptz_priority"]


def collect_users():
    logger.debug("collect users")
    all_users = []
    for user in host.settings("users").ls():
        if user.type == "User" and user.name not in ("Admin", "Script"):
            user.group_acl = None
            if user["group"]:
                user.group_acl = host.settings("users/%s" % user["group"])["acl"]
            user.rights = UserRightsChecker(user)
            all_users.append(user)
    return all_users


def _check_permission(server):
    try:
        channels = server.cd("channels")
        for channel in channels.ls():
            channel_name = channel.name
            break
        return channels
    except ValueError:
        logger.warning("exception:", exc_info=True)


def generate_xlsx_report(folder_path):
    logger.debug("Starting create report...")
    try:
        xlsx_report_path = os.path.join(
            folder_path,
            "Users rights for channels %s .xlsx"
            % datetime.now().strftime("%Y.%m.%d %H-%M-%S"),
        )
        _row = 0
        workbook = xlsxwriter.Workbook(xlsx_report_path)
        worksheet = workbook.add_worksheet()
        header_format = workbook.add_format({"bold": True, "align": "center"})
        row_format = workbook.add_format({"align": "center", "valign": "vcenter"})
        headers_list = [
            loc.report.username,
            loc.report.server_name,
            loc.report.channel_name,
            loc.report.view,
            loc.report.archive,
            loc.report.sound,
            loc.report.ptz,
            loc.report.modify,
            loc.report.setup,
        ]

        for row_num, header in enumerate(headers_list):
            worksheet.write(0, row_num, header, header_format)

        users = collect_users()
        _row += 1
        for server in host.settings("/").ls():
            if server.type in ("LocalServer", "RemoteServer"):
                channels = _check_permission(server)
                if channels:
                    for channel in channels.ls():
                        if (
                            channel.type == "Channel"
                            and not channel["archive_zombie_flag"]
                        ):
                            host.stats()["run_count"] += 1
                            for user in users:
                                worksheet.write(_row, 0, user.name, row_format)
                                worksheet.write(_row, 1, server.name, row_format)
                                worksheet.write(_row, 2, channel.name, row_format)
                                worksheet.write(
                                    _row,
                                    3,
                                    str(user.rights.check_view_rights(channel.path)),
                                    row_format,
                                )
                                worksheet.write(
                                    _row,
                                    4,
                                    str(user.rights.check_archive_rights(channel.path)),
                                    row_format,
                                )
                                worksheet.write(
                                    _row,
                                    5,
                                    str(user.rights.check_sound_rights(channel.path)),
                                    row_format,
                                )
                                worksheet.write(
                                    _row,
                                    6,
                                    str(user.rights.check_ptz_rights(channel.path)),
                                    row_format,
                                )
                                worksheet.write(
                                    _row,
                                    7,
                                    str(user.rights.check_modify_rights(channel.path)),
                                    row_format,
                                )
                                worksheet.write(
                                    _row,
                                    8,
                                    str(user.rights.check_setup_rights(channel.path)),
                                    row_format,
                                )
                                _row += 1
        worksheet.freeze_panes(1, 0)
        worksheet.autofilter("A1:I%d" % _row)
        worksheet.set_column("A:C", 20)
        workbook.close()
        logger.debug("Report success exported to %s" % xlsx_report_path)
        raise ValueError("Report success exported to %s" % xlsx_report_path)
    except OSError as err:
        logger.warning("exception:", exc_info=True)
        raise err


generate_xlsx_report(FOLDER_PATH)
